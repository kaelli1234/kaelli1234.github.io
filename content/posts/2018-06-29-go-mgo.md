---
date: "2018-06-29"
title: Golang mgo ä½¿ç”¨å¿ƒå¾—
description: go, golang, mgo
slug: go-mgo
categories:
- Web
tags:
- golang
comments: true
---

æœ€è¿‘åœ¨ä½¿ç”¨mgoçš„è¿‡ç¨‹ä¸­é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œæ€»ç»“æ ‡è®°ä¸€ä¸‹ã€‚

1ã€å…³äºmgoçš„è¿æ¥æ± é—®é¢˜ã€‚ç›¸å…³çš„å‡ ä¸ªæ–¹æ³•å¦‚ä¸‹
```go
Dial(url string) (*Session, error)
func (*Session) Clone() *Session
func (*Session) Copy() *Session
```
ç”¨ä»¥ä¸Šä¸‰ä¸ªæ–¹æ³•å¾—åˆ°çš„Sessionï¼Œä½¿ç”¨å®Œåéœ€è¦Close()ï¼Œå¦‚æœä¸closeçš„è¯ï¼Œè¿æ¥æ± ä¸­çš„sessionä¼šä¸€ç›´å¢åŠ ï¼Œç›´åˆ°é»˜è®¤é…ç½®çš„4096ã€‚ä¹‹åè·å–sessionçš„åç¨‹ä¼šsleepç­‰å¾…ï¼Œç›´åˆ°æœ‰å¯ç”¨çš„sessionã€‚ä¸šåŠ¡ç«¯çš„è¡¨ç°å°±æ˜¯ç¨‹åºæŒ‚æ­»ï¼Œç±»ä¼¼æ­»é”çš„è¡¨ç°ğŸ˜‚ã€‚**æ‰€ä»¥sessionç”¨å®Œåä¸€å®šè¦defer closeæ‰**ã€‚

2ã€é’ˆå¯¹1ä¸­æåˆ°çš„æƒ…å†µï¼Œå†™äº†ä¸ªæ–¹æ³•è°ƒç”¨mgo Collectionä¸‹å¯¹åº”çš„å‡½æ•°ã€‚
```go
package main

import (
    "fmt"
    "gopkg.in/mgo.v2"
)

var (
    session *mgo.Session
)

func Session() *mgo.Session {
    if session == nil {
        var err error
        session, err = mgo.Dial("root:root@127.0.0.1:27017")
        if err != nil {
            panic(err)
        }
    }
    return session.Clone()
}

func Magic(database string, collection string, f func(*mgo.Collection) error) error {
    session := Session()
    defer func() {
        if session != nil {
            session.Close()
        }
    }()

    c := session.DB(database).C(collection)
    return f(c)
}

func main() {
    var m interface{}
    err := Magic("test", "test", func(c *mgo.Collection) error {
        return c.Find(nil).One(&m)
    })
    fmt.Println(err, m)
}

```

---

**å‚è€ƒ**

* [https://godoc.org/gopkg.in/mgo.v2](https://godoc.org/gopkg.in/mgo.v2)
* [http://www.cnblogs.com/shenguanpu/p/5318727.html](http://www.cnblogs.com/shenguanpu/p/5318727.html)
* [https://golangtc.com/t/53073b69320b526197000067](https://golangtc.com/t/53073b69320b526197000067)